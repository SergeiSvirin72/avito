# Тестовое задание для стажёра Backend
## Реализация
- ЯП Go
- Веб-фреймворк Gin
- СУБД Postgres
- Кэш Redis
- Деплой Docker, Docker compose
- Библиотека Testify для e2e-тестов
- Vegeta для нагрузочных тестов

## Ход решения
В репозитории приложены e2e-тесты, конфигурация линтера `.golangci.yml` и
результаты нагрузочного тестирования (текст `doc/load_testing.txt`, график `doc/load_testing.html`).

Для адаптации под значительное увеличение количества тегов и фичей использованы индексы в базе данных.

Полученные из базы данных пользователи и баннеры сохраняются в кэше для передачи информации, 
которая была актуальна 5 минут назад (пользователи - 30 минут).

Отложенное удаление баннеров по фиче или тегу реализовано при помощи воркера, запущенного в отдельной горутине.

Я столкнулся с проблемой выполнения всех вводных условий в базе данных.
Мною было принято решение сделать фичи уникальными (добавить поле `banners.feature_id` в уникальный индекс),
чтобы выполнялось условие "Фича и тег однозначно определяют баннер".
Поэтому **(ВАЖНО!)** при создании или обновлении баннера, убедитесь,
что он принадлежит уникальной (незанятой другим баннером) фиче.

## Запуск
### Окружение разработчика
Чтобы поднять окружение разработчика, необоходимо выполнить команды в папке с Makefile'ом.  

Поднять контейнеры:
```
make devUp
```
При первом запуске выполнить миграции:
```
make devMigrationUp
```
### Тестовое окружение
Тесты выполняются в отдельном окружении, на тестовой базе данных. Чтобы поднять тестовое окружение, 
необходимо выполнить команды в папке с Makefile'ом.  

Поднять контейнеры:
```
make testUp
```
При первом запуске выполнить миграции:
```
make testMigrationUp
```
Выполнить тесты:
```
make testRunTests
```
## Авторизация
Реализована через Bearer-токен. В Postman необходимо открыть вкладку `Auth`, выбрать тип `Bearer Token`, 
подставить токен в поле `Token`. Чтобы получить токен необходимо сделать запрос на эндпоинт `/auth`.  

Тело запроса для администратора:
```
{
    "email": "admin@test.com",
    "password": "1234"
}
```
Тело запроса для обычного пользователя:
```
{
    "email": "user1@test.com",
    "password": "1234"
}
```
## API
В репозитории приложена коллекция Postman `doc/avito.postman_collection.json` и Swagger `doc/api.yaml`.
API выполнен в соответствии со Swagger из задания, и добавлены дополнительные эндпоинты:

1. **POST /auth** - Аутентификация и получение авторизационного токена
2. **GET /banner_history?banner_id=1** - Получить три предыдущие версии баннера
3. **POST /banner_history?history_id=1** - Вернуться к предыдущей версии баннера
4. **DELETE /banner?tag_id=1** - Отложенное удаление баннеров по фиче или тегу